"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _nodeFs = require("node:fs");
var _bundleloader = _interopRequireDefault(require("./bundleloader.js"));
var _loader = _interopRequireDefault(require("../util/loader.js"));
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
class LocalLoader extends _bundleloader.default {
  fileWatcherDebounce = 1000;
  #dcnDirectory = null;
  #watch = false;
  #watcher = null;
  #debounceTimeout = null;
  constructor(dcnDirectory, watch = false) {
    super("", "", "", "");
    this.#dcnDirectory = dcnDirectory;
    this.#watch = watch;
  }
  start() {
    if (this.#watch) {
      this.#watcher = (0, _nodeFs.watch)(this.#dcnDirectory, {
        persistent: true,
        recursive: true
      }, this.#onFileChange.bind(this));
      this.#watcher.on("error", e => this.emit("requestFailed", e));
    }
    this.#load();
  }
  async stop() {
    clearTimeout(this.#debounceTimeout);
    this.#watcher?.close();
  }
  #onFileChange(/* eventType, filename */
  ) {
    clearTimeout(this.#debounceTimeout);
    this.#debounceTimeout = setTimeout(() => {
      this.#debounceTimeout = null;
      this.#load();
    }, this.fileWatcherDebounce);
  }
  async #load() {
    const result = await _loader.default.load(this.#dcnDirectory);
    this.emit("change", result);
  }
}
exports.default = LocalLoader;