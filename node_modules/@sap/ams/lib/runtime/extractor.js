const pump = require('pump');
const { InMemoryStream } = require('./common');

const tgz = require("compressing/lib/tgz");
const uncompress_directory = require("compressing").tgz.uncompress;

async function uncompress(source, dest, opts) {
    opts = opts || {};
    opts.source = source;

    return new Promise((resolve, reject) => {
        let entryCount = 0;
        let successCount = 0;
        let isFinish = false;
        function done() {
            // resolve when both stream finish and file write finish
            if (isFinish && entryCount === successCount) resolve();
        }

        let name = "";

        new tgz.UncompressStream(opts)
        .on('finish', () => {
            isFinish = true;
            done();
        })
        .on('error', reject)
        .on('entry', (header, stream, next) => {
            name = header.name;
            stream.on('end', ()=>{                
                dest[name] = dest[name]?.getString()
                next();
            });

            if (header.type === 'file') {
                entryCount++;
                const memstream = new InMemoryStream();
                dest[header.name] = memstream;

                pump(stream, memstream, err => {
                    if (err) return reject(err);
                    successCount++;
                    done();
                });
            } else { 
                // directory ---> really needed?
                dest[header.name] = null;
                stream.resume();
            }
        });
    });
}

module.exports = async function(bundle, root) {
    if(root) {
        return uncompress_directory(bundle, root);
    } else {
        const ret = {};
        await uncompress(bundle, ret);
        return ret;
    }        
}
