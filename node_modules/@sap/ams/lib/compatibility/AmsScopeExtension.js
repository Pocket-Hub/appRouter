const Principle = require("../Principle");
const RolesProvider = require("../roles/RolesProvider");

/**
 * This class allows applications using @sap/xssec to make scope checks with the XSUAA API for users authenticated via SAP Cloud Identity Service token.
 * It is intended to be used during transmission phases when migrating from XSUAA to SAP Cloud Identity Service with AMS.
 * It should be replaced by adopting the @sap/ams API instead for authorization checks which also provides a mechanism to support both XSUAA and SAP Cloud Identity Service tokens. 
 */
class AmsScopeExtension {
    xsappname;
    rolesProvider;

    /**
     * Creates an instance of AmsScopeExtension that can be passed in the list of context extensions to configure an IdentityService instance of @sap/xssec.
     * All SecurityContexts opened on this service will have the checkScope and checkLocalScope methods to support scope checks with the XSUAA API.
     * @param {string} xsappname An xsappname that is expected as prefix for the scopes when calling checkLocalScope
     */
    constructor(xsappname) {
        this.xsappname = xsappname;
        this.rolesProvider = new RolesProvider().withRolesCache();
    }

    /**
     * Decorates the IdentityServiceSecurityContext created by @sap/xssec via createSecurityContext from an IdentityService instance configured to use this extension.
     * @param {IdentityServiceSecurityContext} ctx A SecurityContext instance created on an IdentityService by @sap/xssec
     */
    async extendSecurityContext(ctx) {
        const token = ctx.token;
        const tenant = token.appTid;
        const userId = token.scimId;

        const principle = new Principle(tenant, userId);
        const userRoles = await this.rolesProvider.getRoles(principle);

        ctx.getScopes = () => userRoles;
        ctx.checkScope = (scope) => userRoles.includes(scope);
        ctx.checkLocalScope = (scope) => userRoles.includes(`${this.xsappname}.${scope}`);
    }
}

module.exports = AmsScopeExtension;