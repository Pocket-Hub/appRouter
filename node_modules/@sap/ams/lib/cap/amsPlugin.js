const cds = require("@sap/cds");

const env = require("./config/capAmsEnv");
const RestrictionsProvider = require("./RestrictionsProvider");
const RolesMiddleware = require("./RolesMiddleware");

const LOG = cds.log("ams");
const DEBUG = cds.debug("ams");
const RUNTIME_COMMANDS = ["serve", "watch"];

let initialized = false;
let pdp;

/** Entry-point for the AMS plugin. Must only be called once to bootstrap the plugin when the CAP application starts. */
function init() {
    if (initialized) {
        throw new Error("AMS plugin has already been initialized.");
    }

    if (cds.cli?.command && !RUNTIME_COMMANDS.includes(cds.cli?.command)) {
		DEBUG?.(`AMS Plugin not loaded because cds.cli.command is neither of these: ${RUNTIME_COMMANDS}.`);
        return;
    }

    if (!env.supportedAuthActive()) {
		LOG.warn('AMS Plugin not loaded because active auth kind is neither of these: \'mocked\', \'ias\', \'ias-auth\'.');
        return;
    }

    DEBUG?.("AMS Plugin loaded.");
    initialized = true;

    const credentials = cds.env.requires.auth.credentials;
    if (env.iasAuthActive() && !credentials) {
        DEBUG?.("No credentials found for IAS authentication. Please make sure to provide the necessary configuration.");
        return;
    }

    pdp = env.getPdp();
    addRolesMiddleware();
    addAuthorization();
}

/** Creates the RolesMiddleware and registers it behind the 'auth' middleware of the CAP application. */
function addRolesMiddleware() {
    const mw = new RolesMiddleware(pdp);

    cds.once("bootstrap", () => {
        cds.middlewares.add(mw.handleRequest.bind(mw), { after: "auth" });
        DEBUG?.(`Added ${mw} after 'auth' middleware.`);
    });
}

/** Creates the RestrictionsProvider and hooks it into each service that is served by the CAP application. */
function addAuthorization() {
    const rp = new RestrictionsProvider(pdp);

    cds.on("serving", service => {
        rp.hookIntoService(service);
    });
}

module.exports = { init };