const cds = require("@sap/cds");

const LOG = cds.log("ams");

/**
 * Service used for sending AMS events inside CAP applications.
 * To access this service, use require("./config/capAmsEnv").getAmsEventService().
 */
module.exports = class AmsEventService extends cds.MessagingService {

    /**
     * Logs and emits an "getRestrictions" event with the given payload.
     * @param {*} action CAP action
     * @param {*} entity CAP entity
     * @param {*} user CAP user
     * @param {*} attributes Attributes prepared for PDP request that can be modified before the request
     * @returns 
     */
    async sendGetRestrictions(action, entity, user, attributes) {
        let attributesJSONBefore, attributesJSONAfter; // used in debugging to check if attributes were changed in handler
        if(LOG._debug) {
            const attributesJSONBefore = attributes.toString();
            LOG.debug(`Sending getRestrictions event for ${action} ${entity} with attributes: ${attributesJSONBefore}`);
        }

        const result = await this.send("getRestrictions", { action, capEntity: entity, user, attributes });

        if(LOG._debug) {
            attributesJSONAfter = attributes.toString();
            if(attributesJSONBefore !== attributesJSONAfter) {
                LOG.debug(`Modified attributes after getRestrictions event handlers: ${attributesJSONAfter}`);
            } else {
                LOG.debug("Attributes unchanged by getRestrictions event handlers.");
            }
        }

        return result;
    }
}