"use strict";
/* eslint-disable @typescript-eslint/no-var-requires */
const cds = require('@sap/cds');
const { BuildPlugin } = cds.build;
const runtimeEnv = require('@sap/ams').cap.env;
const devEnv = require('./capAmsDevEnv');
const capAmsFlow = require('./capAmsFlow');
const DEBUG = cds.debug('ams|build');
const LOG = cds.log('ams|build');
/** Custom CAP build plugin for AMS to generate DCL policies from the CDS model. */
class AmsBuildPlugin extends BuildPlugin {
    static hasTask() {
        return runtimeEnv.supportedAuthActive();
    }
    init() {
        DEBUG?.('AMS build task initialized.');
        this.task.dest = devEnv.getPathToDclOutput();
    }
    async clean() {
        DEBUG?.('Cleaning previous DCL policies.');
        try {
            await capAmsFlow.cleanDclOutput();
        }
        catch (e) {
            LOG.error('Error cleaning previous DCL policies.', e);
        }
    }
    async build() {
        const model = await this.model();
        if (!model) {
            DEBUG?.('No CDS model found.');
            return;
        }
        DEBUG?.('Compiling CDS model to generate AMS base policies.');
        await capAmsFlow.compileCds(model, this.write.bind(this));
        DEBUG?.('AMS base policies generated.');
        DEBUG?.('Copying custom policies into DCL target folder.');
        await capAmsFlow.copyCustomPolicies(this.write.bind(this));
        DEBUG?.('AMS custom policies copied.');
    }
}
module.exports = AmsBuildPlugin;
//# sourceMappingURL=AmsBuildPlugin.js.map